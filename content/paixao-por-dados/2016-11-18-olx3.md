+++
title = "Como usar o R para escolher um lugar para morar (3) - Converter CEP em coordenadas geogr√°ficas"
date = "2016-11-18 03:00:00"
categories = ["paixao-por-dados"]
+++

<article class="blog-post"> <p>No primeiro e segundo post desta s&#xE9;rie, mostrei como obter dados de apartamentos para alugar a partir do site da OLX e analis&#xE1;-los, mas ainda n&#xE3;o temos a resposta definita para a pergunta que motivou esta s&#xE9;rie: Como o R pode ajudar a escolher um lugar para morar?</p> <p>Uma boa ideia seria plotar os im&#xF3;veis em um mapa, n&#xE3;o? No terceiro post da s&#xE9;rie, mostrarei como fazer isso, al&#xE9;m de como extrair os CEPs dos im&#xF3;veis (novamente por web scraping) e converter os CEPs para endere&#xE7;os, que ser&#xE3;o usados para obter as coordenadas geogr&#xE1;ficas dos apartamentos. &#xC9; mostrado no final um simples gr&#xE1;fico feito com o pacote <code class="highlighter-rouge">ggmap</code>.</p> <figure class="highlight"><pre><code class="language-r"><span class="n">library</span><span class="p">(</span><span class="n">magrittr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">rvest</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">curl</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">readr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">stringr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">ggmap</span><span class="p">)</span></code></pre></figure> <p>Para plotar os im&#xF3;veis em um mapa, precisamos de suas coordenadas geogr&#xE1;ficas. Tais dados podem ser obtidos com a fun&#xE7;&#xE3;o <code class="highlighter-rouge">geocode</code> do pacote <code class="highlighter-rouge">ggmap</code>. Essa fun&#xE7;&#xE3;o aceita um endere&#xE7;o (ou parte de um) como input e retorna a latitude e a longitude. Por exemplo, para o CEP do est&#xE1;dio Maracan&#xE3;, no Rio de Janeiro:</p> <figure class="highlight"><pre><code class="language-r"><span class="n">geocode</span><span class="p">(</span><span class="s2">&quot;20271110&quot;</span><span class="p">)</span></code></pre></figure> <p>Contudo, voc&#xEA; deve se lembrar que n&#xE3;o possu&#xED;mos at&#xE9; o momento nenhum dado sobre o endere&#xE7;o dos im&#xF3;veis. Vamos dar uma olhada novamente nos dados gerados no primeiro post:</p> <figure class="highlight"><pre><code class="language-r"><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv2</span><span class="p">(</span><span class="s2">&quot;/home/sillas/R/Projetos/olx/data/post1-df-olx.csv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">stringsAsFactors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code></pre></figure> <figure class="highlight"><pre><code class="language-text">## link
## 1 http://rj.olx.com.br/rio-de-janeiro-e-regiao/imoveis/excelente-quarto-e-sala-mobiliado-267207757
## 2 http://rj.olx.com.br/rio-de-janeiro-e-regiao/imoveis/assuncao-450-313-238033660
## 3 http://rj.olx.com.br/rio-de-janeiro-e-regiao/imoveis/excelente-apartamento-no-pechincha-269066615
## 4 http://rj.olx.com.br/rio-de-janeiro-e-regiao/imoveis/apartamento-em-botafogo-257852884
## 5 http://rj.olx.com.br/rio-de-janeiro-e-regiao/imoveis/apto-2-quadras-da-praia-primeira-locacao-265081945
## 6 http://rj.olx.com.br/rio-de-janeiro-e-regiao/imoveis/excelente-apartamento-pe-na-areia-196737787
## titulo preco cidade
## 1 Excelente quarto e sala mobiliado 1600 Rio de Janeiro
## 2 Assun&#xE7;&#xE3;o, 450/313 2300 Rio de Janeiro
## 3 Excelente apartamento no pechincha 1100 Rio de Janeiro
## 4 Apartamento em Botafogo 4900 Rio de Janeiro
## 5 Apto 2 quadras da praia. Primeira loca&#xE7;&#xE3;o 800 Rio de Janeiro
## 6 Excelente apartamento p&#xE9; na areia 2600 Rio de Janeiro
## bairro
## 1 Centro
## 2 Botafogo
## 3 Pechincha
## 4 Botafogo
## 5 Recreio Dos Bandeirantes
## 6 Copacabana
## adicional tem_quarto tem_area
## 1 1 quarto | 40 m&#xB2; | Condom&#xED;nio: RS 370 TRUE TRUE
## 2 1 quarto | 45 m&#xB2; | Condom&#xED;nio: RS 375 | 1 vaga TRUE TRUE
## 3 1 quarto | 40 m&#xB2; | Condom&#xED;nio: RS 480 | 1 vaga TRUE TRUE
## 4 4 quarto | 120 m&#xB2; | Condom&#xED;nio: RS 1200 | 2 vagas TRUE TRUE
## 5 1 quarto | 35 m&#xB2; | Condom&#xED;nio: RS 50 TRUE TRUE
## 6 2 quarto | 62 m&#xB2; | Condom&#xED;nio: RS 950 TRUE TRUE
## tem_taxa tem_garagem qtd_quarto taxa_condominio area_condominio garagem
## 1 TRUE FALSE 1 370 40 NA
## 2 TRUE TRUE 1 375 45 1
## 3 TRUE TRUE 1 480 40 1
## 4 TRUE TRUE 4 1200 120 2
## 5 TRUE FALSE 1 50 35 NA
## 6 TRUE FALSE 2 950 62 NA</code></pre></figure> <p>Como eu disse, n&#xE3;o temos nenhum dado sobre a localiza&#xE7;&#xE3;o do im&#xF3;vel - al&#xE9;m do bairro, o que &#xE9; muito pouco. Isso acontece porque a p&#xE1;gina que lista os apartamentos n&#xE3;o informa esses dados, como se v&#xEA; na imagem abaixo:</p> <p><img src="http://i.imgur.com/4mXiS3M.png" alt=""></p> <p>Dentro da p&#xE1;gina do im&#xF3;vel, j&#xE1; conseguimos ter pelo menos seu CEP:</p> <p><img src="http://i.imgur.com/3XF4XS9.png" alt=""></p> <p>Ou seja: para extrair o CEP do im&#xF3;vel, &#xE9; necess&#xE1;rio entrar em sua p&#xE1;gina! Isso aumenta a complexidade do c&#xF3;digo em n vezes porque agora teremos de fazer o scraping n&#xE3;o de 245 p&#xE1;ginas mas sim de mais de 10000.</p> <p>Para extrair o CEP, a l&#xF3;gica &#xE9; a mesma da mostrada no primeiro post desta s&#xE9;rie. Como vamos extrair apenas este &#xFA;nico dado da p&#xE1;gina, vou mostrar o passo-a-passo do scraping mais detalhadamente.</p> <p>Primeiramente, n&#xF3;s precisamos saber qual &#xE9; o elemento HTML (chamado de tag) que identifica o CEP no c&#xF3;digo fonte da p&#xE1;gina. N&#xE3;o precisa ser expert em HTML para saber isso (eu mesmo n&#xE3;o sei nada), basta utilizar as ferramentas do Firefox ou do Chrome para inspecionar a p&#xE1;gina e descobrir a tag do elemento desejado.</p> <p>Abra <a href="http://rj.olx.com.br/rio-de-janeiro-e-regiao/imoveis/excelente-quarto-e-sala-mobiliado-267207757">esta p&#xE1;gina</a>, clique com o bot&#xE3;o direito no CEP e clique em Inspecionar elemento (ou algo semelhante). Ser&#xE1; aberto um menu na parte inferior do browser com o c&#xF3;digo fonte da p&#xE1;gina. Passe o mouse nas diferentes linhas e veja os elementos que correspondem &#xE0;s tags do c&#xF3;digo.</p> <p><img src="http://i.imgur.com/IuhcpEJ.png" alt=""></p> <p>Na imagem acima, veja que o CEP est&#xE1; dentro do bloco (n&#xE3;o sei se &#xE9; assim mesmo que isso &#xE9; chamado) da localiza&#xE7;&#xE3;o do apartamento, cuja tag &#xE9; indicada pelo string <code class="highlighter-rouge">OLXad-location-map mb20px</code>. Na verdade, ap&#xF3;s fazer alguns testes, descobri que usamos o string <code class="highlighter-rouge">.OLXad-location-map</code> para localizar a tag da localiza&#xE7;&#xE3;o do im&#xF3;vel. Como n&#xE3;o conhe&#xE7;o HTML, n&#xE3;o sei explicar o porqu&#xEA; disso acontecer. Web scraping tem muito de tentar diversos inputs at&#xE9; conseguir o resultado desejado.</p> <p>Vamos usar essa informa&#xE7;&#xE3;o em nosso c&#xF3;digo:</p> <figure class="highlight"><pre><code class="language-r"><span class="n">url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">&quot;http://rj.olx.com.br/rio-de-janeiro-e-regiao/imoveis/excelente-quarto-e-sala-mobiliado-267207757&quot;</span><span class="w">
</span><span class="n">mycurl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">curl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curl</span><span class="o">::</span><span class="n">new_handle</span><span class="p">(</span><span class="s2">&quot;useragent&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Mozilla/5.0&quot;</span><span class="p">))</span><span class="w">
</span><span class="n">url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_html</span><span class="p">(</span><span class="n">mycurl</span><span class="p">,</span><span class="w"> </span><span class="n">encoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ISO8859-1&quot;</span><span class="p">)</span><span class="w">
</span><span class="c1"># Localizando a tag de localiza&#xE7;&#xE3;o do im&#xF3;vel
</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">html_nodes</span><span class="p">(</span><span class="s2">&quot;.OLXad-location-map&quot;</span><span class="p">)</span><span class="w">
</span><span class="c1"># Imprimir o elemento x em formato de texto:
</span><span class="n">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code></pre></figure> <figure class="highlight"><pre><code class="language-text">## {xml_nodeset (1)}
## [1] &lt;div class=&quot;OLXad-location-map mb20px&quot;&gt;\n\t\t\t\t&lt;div class=&quot;atribut ...</code></pre></figure> <figure class="highlight"><pre><code class="language-r"><span class="n">html_text</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code></pre></figure> <figure class="highlight"><pre><code class="language-text">## [1] &quot;\n\t\t\t\t\n\t\t\t\t\tLocaliza&#xE7;&#xE3;o\n\t\t\t\t\t\t\n\t\t\t\t\t\t\t\n\n\n\n\n\n\n\t\n\n\t\n\t\t\t\t\t\n\t\t\t\t\t\tMunic&#xED;pio:\n\t\t\t\t\t\t\n\t\t\t\t\t\t\tRio de Janeiro\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\n\t\t\n\n\t\t\n\n\t\t\t\n\t\t\t\t\n\t\t\t\t\tCEP do im&#xF3;vel:\n\t\t\t\t\t\n\t\t\t\t\t\t20230-010\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\n\n\t\t\n\n\t\t\n\t\t\t\n\t\t\t\t\n\t\t\t\t\tBairro:\n\t\t\t\t\t\n\t\t\t\t\t\tCentro\n\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\n\t\t\t\n\t\t\n\n\t\n\n\t\t\t\t\t\t\n\t\t\t\t\t\t\t\n\n\t\n\t\t\n\t\t\tVer localiza&#xE7;&#xE3;o no mapa\n\t\t\n\t\t\n\t\n\n\n\t\t\t\t\t\t\n\t\t\t\t\n\t\t\t&quot;</code></pre></figure> <p>Podemos ver que, conforme o esperado, o CEP est&#xE1; dentro do bloco de localiza&#xE7;&#xE3;o. S&#xF3; isso j&#xE1; seria necess&#xE1;rio para extrair o CEP, mas n&#xF3;s conseguimos melhorar isso para facilitar o processo de data cleaning posteriormente.</p> <p>Perceba que dentro da tag <code class="highlighter-rouge">OLXad-location-map mb20px</code>, existe uma subtag <code class="highlighter-rouge">p</code> que identifica apenas o CEP do im&#xF3;vel.</p> <figure class="highlight"><pre><code class="language-r"><span class="n">url</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">html_nodes</span><span class="p">(</span><span class="s2">&quot;.OLXad-location-map&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">html_nodes</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span></code></pre></figure> <figure class="highlight"><pre><code class="language-text">## {xml_nodeset (3)}
## [1] &lt;p class=&quot;text&quot;&gt;\n\t\t\t\t\t\t&lt;span class=&quot;term&quot;&gt;Munic&#xED;pio:&lt;/span&gt;\n ...
## [2] &lt;p class=&quot;text&quot;&gt;\n\t\t\t\t\t&lt;span class=&quot;term&quot;&gt;CEP do im&#xF3;vel:&lt;/span&gt; ...
## [3] &lt;p class=&quot;text&quot;&gt;\n\t\t\t\t\t&lt;span class=&quot;term&quot;&gt;Bairro:&lt;/span&gt;\n\t\t\ ...</code></pre></figure> <p>O output gerado &#xE9; da classe <code class="highlighter-rouge">xml_nodeset</code> e tem tr&#xEA;s elementos: o munic&#xED;pio, o CEP e o bairro. Estamos interessados apenas no CEP, portanto:</p> <figure class="highlight"><pre><code class="language-r"><span class="c1">#html_text serve para converter um objeto xml_nodeset em texto
</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">html_nodes</span><span class="p">(</span><span class="s2">&quot;.OLXad-location-map&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">html_nodes</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">.</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">html_text</span><span class="p">()</span><span class="w">
</span><span class="n">x</span></code></pre></figure> <figure class="highlight"><pre><code class="language-text">## [1] &quot;\n\t\t\t\t\tCEP do im&#xF3;vel:\n\t\t\t\t\t\n\t\t\t\t\t\t20230-010\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t&quot;</code></pre></figure> <p>Agora precisamos fazer um pouco de data cleaning. &#xC9; necess&#xE1;rio apenas remover o caractere <code class="highlighter-rouge">-</code> e extrair os algarismos do string. Fazer isso &#xE9; muito f&#xE1;cil gra&#xE7;as ao pacote <code class="highlighter-rouge">stringr</code>.</p> <figure class="highlight"><pre><code class="language-r"><span class="n">x</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">str_replace_all</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w">
</span><span class="n">x</span></code></pre></figure> <figure class="highlight"><pre><code class="language-text">## [1] &quot;\n\t\t\t\t\tCEP do im&#xF3;vel:\n\t\t\t\t\t\n\t\t\t\t\t\t20230010\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t&quot;</code></pre></figure> <figure class="highlight"><pre><code class="language-r"><span class="n">x</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">parse_number</span><span class="p">()</span><span class="w">
</span><span class="n">x</span></code></pre></figure> <figure class="highlight"><pre><code class="language-text">## [1] 20230010</code></pre></figure> <p>Finalmente, conseguimos extrair o CEP do im&#xF3;vel. Vamos ent&#xE3;o aplicar esse mesmo procedimento para os outros apartamentos do data frame. Para automatizar esse processo, criei a fun&#xE7;&#xE3;o <code class="highlighter-rouge">extrairCEP()</code>, que usa uma outra fun&#xE7;&#xE3;o chamada <code class="highlighter-rouge">limparString()</code>. Os c&#xF3;digos de ambas s&#xE3;o mostrados abaixo.</p> <figure class="highlight"><pre><code class="language-r"><span class="c1"># definir fun&#xE7;&#xE3;o para limpar strings coletadas
</span><span class="n">limparString</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1"># x = string coletado do olx
</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">str_replace_all</span><span class="p">(</span><span class="s2">&quot;[\t]&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">str_replace_all</span><span class="p">(</span><span class="s2">&quot;[\n]&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">str_replace_all</span><span class="p">(</span><span class="s2">&quot;Apartamentos&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">str_replace_all</span><span class="p">(</span><span class="s2">&quot;An&#xFA;ncio Profissional&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">str_replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">str_replace_all</span><span class="p">(</span><span class="s2">&quot;[R$]&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">str_replace_all</span><span class="p">(</span><span class="s2">&quot;[.]&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">str_trim</span><span class="p">()</span><span class="w"> </span><span class="nf">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w"> </span><span class="n">extrairCEP</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1"># url = url de um quarto
</span><span class="w"> </span><span class="n">mycurl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">curl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">curl</span><span class="o">::</span><span class="n">new_handle</span><span class="p">(</span><span class="s2">&quot;useragent&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Mozilla/5.0&quot;</span><span class="p">))</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_html</span><span class="p">(</span><span class="n">mycurl</span><span class="p">,</span><span class="w"> </span><span class="n">encoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ISO8859-1&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">#url &lt;- read_html(url, encoding = &quot;ISO8859-1&quot;)
</span><span class="w"> </span><span class="c1">#url &lt;- html_nodes(url, &quot;.OLXad-location-map&quot;) deprecated
</span><span class="w"> </span><span class="c1"># if clause para pegar casos em que o node id &#xE9; diferente
</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">html_nodes</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.OLXad-location-map&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">html_nodes</span><span class="p">(</span><span class="s2">&quot;.OLXad-location-map&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">html_nodes</span><span class="p">(</span><span class="s2">&quot;.OLXad-location&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">html_nodes</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">url</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">html_text</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="w"> </span><span class="n">cep</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">limparString</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="w"> </span><span class="n">cep</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">readr</span><span class="o">::</span><span class="n">parse_number</span><span class="p">(</span><span class="n">cep</span><span class="p">)</span><span class="w"> </span><span class="nf">return</span><span class="p">(</span><span class="n">cep</span><span class="p">)</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>Para algumas p&#xE1;ginas, a tag de identifica&#xE7;&#xE3;o do bloco da localiza&#xE7;&#xE3;o do apartamento n&#xE3;o &#xE9; <code class="highlighter-rouge">.OLXad-location-map</code> mas sim <code class="highlighter-rouge">.OLXad-location</code>, por isso a necessidade da if clause na fun&#xE7;&#xE3;o <code class="highlighter-rouge">extrairCEP()</code>.</p> <p>Outro problema &#xE9; que, em alguns casos, o CEP do im&#xF3;vel n&#xE3;o &#xE9; informado, fazendo necess&#xE1;rio usar a fun&#xE7;&#xE3;o <code class="highlighter-rouge">tryCatch()</code> para retornar <code class="highlighter-rouge">NA</code> em caso de erro:</p> <figure class="highlight"><pre><code class="language-r"><span class="n">system.time</span><span class="p">(</span><span class="n">ceps</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unname</span><span class="p">(</span><span class="n">sapply</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">link</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="n">tryCatch</span><span class="p">({</span><span class="n">extrairCEP</span><span class="p">(</span><span class="n">i</span><span class="p">)},</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">e</span><span class="p">){</span><span class="kc">NA</span><span class="p">}))))</span></code></pre></figure> <figure class="highlight"><pre><code class="language-text">## user system elapsed ## 10.204 2.376 12.559</code></pre></figure> <figure class="highlight"><pre><code class="language-r"><span class="n">ceps</span></code></pre></figure> <figure class="highlight"><pre><code class="language-text">## [1] 20230010 NA 22740360 22251040 NA 22060040 20231091
## [8] 22040002 NA 24350200 23071040 22783020 24130223 23580250
## [15] 22763152 22010011 20540140 NA 22471120 22793329 22231180
## [22] 22471120 22220000 20770000 22753005 23515127 22630010 22041011
## [29] 20521050 22020001 22775033 24240182 NA 20251031 20251031
## [36] 24342079 24342079 22260110 22290040 NA 21320190 20550052
## [43] 22071110 24070000 20745300 22740010 22631030</code></pre></figure> <figure class="highlight"><pre><code class="language-r"><span class="c1"># incorporar ao data frame
</span><span class="n">df</span><span class="o">$</span><span class="n">cep</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ceps</span></code></pre></figure> <p>Como eu mostrei no in&#xED;cio do post, seria poss&#xED;vel conseguir as coordenadas do im&#xF3;vel (ou pelo menos da rua dele) a partir do CEP. Entretanto, em alguns testes que eu fiz, percebi que em alguns casos a acur&#xE1;cia n&#xE3;o era muito grande. Sabemos que quanto mais dados de endere&#xE7;o o Google tiver, mais precisas ser&#xE3;o as coordenadas. Por isso, &#xE9; importante ter n&#xE3;o somente o CEP mas tamb&#xE9;m o nome da rua, bairro, cidade e estado.</p> <p>Para conseguir esses dados a partir do CEP, usei uma fun&#xE7;&#xE3;o criada e postada no grupo <a href="https://www.facebook.com/groups/1410023525939155/">R Brasil - Programadores</a> pelo membro Jos&#xE9; de Jesus Filho. Segue seu c&#xF3;digo:</p> <figure class="highlight"><pre><code class="language-r"><span class="n">postal</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">cep</span><span class="p">){</span><span class="w"> </span><span class="c1"># converter cep em endere&#xE7;o
</span><span class="w"> </span><span class="n">library</span><span class="p">(</span><span class="n">httr</span><span class="p">)</span><span class="w"> </span><span class="n">l</span><span class="o">&lt;-</span><span class="nf">list</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">seq_along</span><span class="p">(</span><span class="n">cep</span><span class="p">)){</span><span class="w"> </span><span class="n">cep</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stringr</span><span class="o">::</span><span class="n">str_replace</span><span class="p">(</span><span class="n">cep</span><span class="p">,</span><span class="s2">&quot;\\D&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">cep</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stringr</span><span class="o">::</span><span class="n">str_pad</span><span class="p">(</span><span class="n">cep</span><span class="p">,</span><span class="m">8</span><span class="p">,</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">cep</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">cep</span><span class="p">)</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">&quot;http://correiosapi.apphb.com/cep/&quot;</span><span class="p">,</span><span class="n">cep</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GET</span><span class="p">(</span><span class="n">url</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">content</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">as</span><span class="o">=</span><span class="s2">&quot;parsed&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">l</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">do.call</span><span class="p">(</span><span class="s2">&quot;rbind&quot;</span><span class="p">,</span><span class="n">l</span><span class="p">))</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">ncol</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="n">x</span><span class="p">[,</span><span class="w"> </span><span class="n">col</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">x</span><span class="p">[,</span><span class="w"> </span><span class="n">col</span><span class="p">])}</span><span class="w"> </span><span class="nf">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
</span><span class="p">}</span></code></pre></figure> <p>Por exemplo, continuando com o CEP do Maracan&#xE3;, a fun&#xE7;&#xE3;o <code class="highlighter-rouge">postal()</code> retorna:</p> <figure class="highlight"><pre><code class="language-r"><span class="n">postal</span><span class="p">(</span><span class="m">20271110</span><span class="p">)</span></code></pre></figure> <figure class="highlight"><pre><code class="language-text">## cep tipoDeLogradouro logradouro bairro cidade estado
## 1 20271110 Avenida Maracan&#xE3; Maracan&#xE3; Rio de Janeiro RJ</code></pre></figure> <p>Como se v&#xEA;, a fun&#xE7;&#xE3;o funciona muito bem, ent&#xE3;o podemos a aplicar para os outros im&#xF3;veis:</p> <figure class="highlight"><pre><code class="language-r"><span class="n">system.time</span><span class="p">(</span><span class="n">df.endereco</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">postal</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">cep</span><span class="p">))</span><span class="w">
</span><span class="c1"># &#xE9; criado um data frame. </span><span class="n">head</span><span class="p">(</span><span class="n">df.endereco</span><span class="p">)</span><span class="w">
</span><span class="c1"># vamos juntar as colunas do data frame de endere&#xE7;os em uma s&#xF3;
</span><span class="err">#</span><span class="w"> </span><span class="n">primeiro</span><span class="w"> </span></code></pre></figure> <p>&#xC9; necess&#xE1;rio juntar todas as colunas do data frame de endere&#xE7;os em uma s&#xF3;. Para juntar diferentes strings com um separador em comum (v&#xED;rgula, por exemplo), &#xE9; recomend&#xE1;vel usar a fun&#xE7;&#xE3;o <code class="highlighter-rouge">str_c()</code> do pacote <code class="highlighter-rouge">stringr</code>.</p> <figure class="highlight"><pre><code class="language-r"><span class="n">df.endereco</span><span class="o">$</span><span class="n">endereco_completo</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df.endereco</span><span class="w"> </span><span class="o">%$%</span><span class="w"> </span><span class="n">str_c</span><span class="p">(</span><span class="n">logradouro</span><span class="p">,</span><span class="w"> </span><span class="n">cep</span><span class="p">,</span><span class="w"> </span><span class="n">bairro</span><span class="p">,</span><span class="w"> </span><span class="n">cidade</span><span class="p">,</span><span class="w"> </span><span class="n">estado</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="w">
</span><span class="n">df.endereco</span><span class="o">$</span><span class="n">endereco_completo</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df.endereco</span><span class="w"> </span><span class="o">%$%</span><span class="w"> </span><span class="n">str_c</span><span class="p">(</span><span class="n">tipoDeLogradouro</span><span class="p">,</span><span class="w"> </span><span class="n">endereco_completo</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="w">
</span><span class="c1"># exemplo de como ficou:
</span><span class="n">df.endereco</span><span class="o">$</span><span class="n">endereco_completo</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">]</span></code></pre></figure> <figure class="highlight"><pre><code class="language-text">## [1] &quot;Rua Riachuelo, 20230010, Centro, Rio de Janeiro, RJ&quot; ## [2] &quot;Rua Assun&#xE7;&#xE3;o, 22251030, Botafogo, Rio de Janeiro, RJ&quot; ## [3] &quot;Estrada do Tindiba, 22740360, Pechincha, Rio de Janeiro, RJ&quot; ## [4] &quot;Rua Marqu&#xEA;s de Olinda, 22251040, Botafogo, Rio de Janeiro, RJ&quot; ## [5] &quot;Rua Risoleta Neves, 22795105, Recreio dos Bandeirantes, Rio de Janeiro, RJ&quot;</code></pre></figure> <figure class="highlight"><pre><code class="language-r"><span class="c1"># incorporando a coluna de endere&#xE7;o completo no data frame principal
</span><span class="n">df</span><span class="o">$</span><span class="n">endereco_completo</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df.endereco</span><span class="o">$</span><span class="n">endereco_completo</span></code></pre></figure> <p>Finalmente, podemos extrair do Google as coordenadas do endere&#xE7;o do im&#xF3;vel com a fun&#xE7;&#xE3;o <code class="highlighter-rouge">geocode()</code>. Antes de usar a fun&#xE7;&#xE3;o, por&#xE9;m, &#xE9; importante lembrar que a API do Google tem um limite de consultas por dia. Voc&#xEA; pode checar seu limite com a fun&#xE7;&#xE3;o <code class="highlighter-rouge">geocodeQueryCheck()</code>.</p> <figure class="highlight"><pre><code class="language-r"><span class="n">geocodeQueryCheck</span><span class="p">()</span></code></pre></figure> <p>Assim, j&#xE1; podemos obter as coordenadas geogr&#xE1;ficas dos im&#xF3;veis:</p> <figure class="highlight"><pre><code class="language-r"><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">geocode</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">endereco_completo</span><span class="p">)</span></code></pre></figure> <figure class="highlight"><pre><code class="language-r"><span class="c1"># incorporando ao data frame
</span><span class="w">
</span><span class="n">df</span><span class="o">$</span><span class="n">lat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">lat</span><span class="w">
</span><span class="n">df</span><span class="o">$</span><span class="n">lon</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span><span class="o">$</span><span class="n">lon</span></code></pre></figure> <p>Uma op&#xE7;&#xE3;o para plotar os im&#xF3;veis em um mapa seria com o pr&#xF3;prio pacote <code class="highlighter-rouge">ggmap</code>:</p> <figure class="highlight"><pre><code class="language-r"><span class="n">qmplot</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">preco</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;red&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">labs</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Aluguel&quot;</span><span class="p">)</span></code></pre></figure> <p><img src="http://sillasgonzaga.github.io/figs/olx3/grafico%20ggmap-1.png" alt="center"></p> <p>Mesmo o gr&#xE1;fico acima sendo uma &#xF3;tima visualiza&#xE7;&#xE3;o, &#xE9; poss&#xED;vel fazer melhor. No pr&#xF3;ximo post, mostrarei como plotar os pontos em um mapa interativo usando o pacote <code class="highlighter-rouge">leaflet</code>.</p> </article>
