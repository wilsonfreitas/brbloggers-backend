+++
title = "Web scraping do site da Secretaria de Segurança Pública de São Paulo"
date = "2017-05-19 20:26:00"
categories = ["curso-r"]
+++

<div id="post-content"> <p>Quando eu trabalhei no N&#xFA;cleo de Estudos da Viol&#xEA;ncia da USP, obter informa&#xE7;&#xF5;es da Secretaria de Seguran&#xE7;a P&#xFA;blica de S&#xE3;o Paulo (SSP) era uma tarefa meio esot&#xE9;rica. Colet&#xE1;vamos os dados de todos os DP&#x2019;s de S&#xE3;o Paulo, que s&#xE3;o aproximadamente 100, e, como fazer isso manualmente era demorado, aplic&#xE1;vamos uma solu&#xE7;&#xE3;o autom&#xE1;tica em dois passos. Primeiro <em>rasp&#xE1;vamos</em> o site da SSP em Python e depois rod&#xE1;vamos uma macro em VBA chamada &#x201C;Mestre Dos Magos&#x201D;, que era respons&#xE1;vel por consolidar as s&#xE9;ries hist&#xF3;ricas em excel. Eu achava o procedimento um pouco herm&#xE9;tico porque nenhum deles tinha sido feito por mim ou pela minha equipe, era uma heran&#xE7;a que a gente n&#xE3;o sabia como consertar se desse algum problema. Para dar um exemplo, no final da minha breve estadia no NEV o script n&#xE3;o funcionava mais, ent&#xE3;o era necess&#xE1;rio baixar tudo manualmente.</p>
<p>Depois dessa &#xE9;poca eu nunca mais mexi com esses dados. Eu sempre tive vontade de implementar uma solu&#xE7;&#xE3;o em R, mas sempre faltou motiva&#xE7;&#xE3;o. Felizmente, na ultima semana minha namorada precisou dos dados da SSP para um trabalho que est&#xE1; fazendo, s&#xF3; que dessa vez o interesse era em todos os 645 munic&#xED;pios do estado de S&#xE3;o Paulo nos anos entre 2013 a 2016. Como n&#xE3;o h&#xE1; como baixar todas essas informa&#xE7;&#xF5;es de uma vez e downloads individuais tomam muito tempo, eu me senti motivado o suficiente para atacar o problema.</p>
<p>Pra ser sincero, foi bem mais f&#xE1;cil do que eu achei que seria. A constru&#xE7;&#xE3;o do programa foi t&#xE3;o simples que cabe at&#xE9; mesmo neste post de blog, mas n&#xE3;o &#xE9; s&#xF3; por isso que ela est&#xE1; aqui. Esse &#xE9; um exemplo minimal de todas as fases de constru&#xE7;&#xE3;o de um <em>scraper</em>.</p>
<div id="os-quatro-passos-para-construir-um-scraper" class="section level2"> <p>Em um esquema aproximado, eu acredito que raspar (ou <em>scrappear</em>) um site pode ser feito em 4 passos:</p>
<ol>
<li>Defina a p&#xE1;gina que voc&#xEA; quer raspar;</li>
<li>Identifique <em>exatamente</em> as requisi&#xE7;&#xF5;es que produzem o que voc&#xEA; quer;</li>
<li>Construa um programa que <em>imite</em> as requisi&#xE7;&#xF5;es que voc&#xEA; faria manualmente;</li>
<li>Repita o passo 3. quantas vezes quiser.</li>
</ol>
<p>Mesmo que existam <em>scrapers</em> mais complicados, &#xE9; verdade que seguir esses passos pelo menos te ajuda a chegar mais perto do que voc&#xEA; realmente precisar&#xE1; fazer depois.</p>
</div>
<div id="defina-o-que-voce-quer" class="section level2"> <p>Tanto o NEV quanto a minha namorada tinham interesse nas tabelas que apareciam numa URL espec&#xED;fica do site: <a href="http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx" class="uri">http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx</a>. A l&#xF3;gica por tr&#xE1;s da divulga&#xE7;&#xE3;o dessas informa&#xE7;&#xF5;es &#xE9; a seguinte: voc&#xEA; escolhe um ano, uma localidade geogr&#xE1;fica/administrativa e um tipo de informa&#xE7;&#xE3;o e ele te devolve uma tabela. Os anos dispon&#xED;veis s&#xE3;o os anos de 2001 a 2017, as localidades s&#xE3;o os cruzamentos entre Munic&#xED;pios, Regi&#xF5;es e Delegacias (notando que voc&#xEA; sempre pode escolher &#x201C;Todos&#x201D;) e os tipos de informa&#xE7;&#xE3;o s&#xE3;o taxas de delito, ocorr&#xEA;ncias registradas por ano, ocorr&#xEA;ncias registradas por m&#xEA;s e produtividade policial. Nesta aplica&#xE7;&#xE3;o vamos procurar contagens de ocorr&#xEA;ncias registradas por m&#xEA;s.</p>
</div>
<div id="identifique-o-que-o-site-faz-por-tras" class="section level2"> <p>Identificar o que o site faz por tr&#xE1;s provavelmente &#xE9; a fase mais complicada da constru&#xE7;&#xE3;o de um <em>scraper</em>. A dificuldade &#xE9; que n&#xE3;o existe um algoritmo que fa&#xE7;a isso pra voc&#xEA;. Normalmente eu sigo alguns passos, mas eles exigem uma dose de <em>insight</em> para funcionar, o que implica que talvez n&#xE3;o seja poss&#xED;vel seguir todos os passos em sequ&#xEA;ncia.</p>
<ol>
<li>Entre na p&#xE1;gina imediatamente anterior &#xE0; p&#xE1;gina que voc&#xEA; quer acessar.</li>
<li>Abra as ferramentas de desenvolvedor dos seu navegador (isso normalmente &#xE9; equivalente &#xE0; &#x201C;aperte F12&#x201D;).</li>
<li>Selecione a aba &#x201C;Network&#x201D; (ou &#x201C;Rede&#x201D;) na caixa de ferramentas do desenvolvedor.</li>
<li>V&#xE1; para a p&#xE1;gina que voc&#xEA; quer.</li>
<li>Na lista de requisi&#xE7;&#xF5;es que o site fez ao servidor, identifique aquela(s) que &#xE9;(s&#xE3;o) relevante(s) a sua pesquisa.</li>
</ol>
<p>Parece muito louco n&#xE9;? No geral, &#xE9; muito louco sim, mas quando voc&#xEA; d&#xE1; sorte &#xE9; f&#xE1;cil. Vou mostrar o que acontece no nosso exemplo:</p> <div id="ferramentas-do-desenvolvedor-e-aba-network" class="section level3"> <p>Em qualquer navegador, as ferramentas do desenvolvedor mostram o <em>background</em> do que aparece na tela. Se estiver nessa aba, quando voc&#xEA; entrar em <a href="http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx" class="uri">http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx</a> e apertar F5, vai encontrar uma tela mais ou menos parecida com a tela abaixo:</p>
<p><img src="http://curso-r.com/blog/2017-05-19-scrapper-ssp_files/figure-html/unnamed-chunk-1-1.png" width="768"></p>
<p>Cada linha representa uma requisi&#xE7;&#xE3;o, que &#xE9; essencialmente o envio de um arquivo .html ao servidor. O conte&#xFA;do que visualizamos na tela &#xE9; o resultado de todas essas requisi&#xE7;&#xF5;es e, se destrincharmos cada uma delas, podemos identificar aquelas que s&#xE3;o relevantes para o nosso problema.</p>
</div>
<div id="a-requisicao" class="section level3"> <p>O pr&#xF3;ximo passo &#xE9; identificar o que &#xE9; que o navegador pede ao servidor quando te devolve o que voc&#xEA; quer. Se voc&#xEA; escolher o ano de 2017 na caixa de sele&#xE7;&#xE3;o de anos, por exemplo, vai encontrar uma tela parecida com essa aqui.</p>
<p><img src="http://curso-r.com/blog/2017-05-19-scrapper-ssp_files/figure-html/unnamed-chunk-2-1.png" width="768"></p>
<p>Antes de prosseguir, &#xE9; necess&#xE1;rio fazer uma inspe&#xE7;&#xE3;o meticulosa de todas as requisi&#xE7;&#xF5;es que aparecem, mas vou encurtar a discuss&#xE3;o afirmando que a primeira delas &#xE9; a mais importante. Existem muitas maneiras de deduzir que ela &#xE9; uma boa candidata, como por exemplo olhando que ela &#xE9; a &#xFA;nica requisi&#xE7;&#xE3;o <em>relevante</em> que recebe html, mas vou pular essa parte.</p>
<p>Segundo o nosso dedo duro, a requisi&#xE7;&#xE3;o utiliza o m&#xE9;todo &#x201C;POST&#x201D; e, quando clicamos nela, temos informa&#xE7;&#xF5;es sobre ela no painel ao lado. Como eu falei acima, uma requisi&#xE7;&#xE3;o &#xE9; um arquivo .html que &#x201C;pede&#x201D; alguma ao servidor com base no seu conte&#xFA;do. No geral, um bom lugar para procurar o que a requisi&#xE7;&#xE3;o est&#xE1; pedindo &#xE9; o seu conjunto de par&#xE2;metros, na aba &#x201C;Params&#x201D; do painel de detalhamento da requisi&#xE7;&#xE3;o.</p>
<p><img src="http://curso-r.com/blog/2017-05-19-scrapper-ssp_files/figure-html/unnamed-chunk-3-1.png" width="768"></p>
<p>Quando inspecionamos essa requisi&#xE7;&#xE3;o &#x201C;POST&#x201D;, identificamos que as coisas que s&#xE3;o relevantes para o conte&#xFA;do da p&#xE1;gina est&#xE3;o nesses par&#xE2;metros. De fato, pensando ingenuamente, clicar apenas em &#x201C;2017&#x201D; deve mexer nos par&#xE2;metros que tem a ver com isso mas deve deixar os demais par&#xE2;metros fixos. Por sorte, os par&#xE2;metros observados batem com essa expectativa: &#x201C;__EVENTTARGET&quot; &#xE9; <code>ctl00$conteudo$$ddlAnos</code> &#xE9; um <em>placeholder</em> que tem a ver com a caixa de sele&#xE7;&#xE3;o em que mexemos, os dois pr&#xF3;ximos par&#xE2;metros est&#xE3;o zerados, &#x201C;__VIEWSTATE&quot; e &#x201C;__EVENTVALIDATION&quot; s&#xE3;o par&#xE2;metros da sess&#xE3;o, e, por fim, temos os par&#xE2;metros da consulta, que est&#xE3;o todos zerados com exce&#xE7;&#xE3;o de <code>ctl00$conteudo$$ddlAnos</code>.</p>
<p>Parece que os par&#xE2;metros tem tudo a ver com a sa&#xED;da. Ser&#xE1; que mexer apenas neles basta para copiar a requisi&#xE7;&#xE3;o do navegador?</p>
</div>
</div>
<div id="crie-um-robo-que-imita-o-que-um-humano-faria" class="section level2"> <p>Agora que sabemos um pouco mais sobre como as requisi&#xE7;&#xF5;es funcionam, vamos tentar fazer o POST mais simples de todos: ele s&#xF3; tem os par&#xE2;metros da &#xFA;ltima imagem. Em R, o jeito mais f&#xE1;cil de fazer requisi&#xE7;&#xF5;es &#xE9; usando o pacote <code>httr</code>. Ele &#xE9; bem intuitivo e flex&#xED;vel, de tal forma que fazer um POST &#xE9; feito simplesmente chamando a fun&#xE7;&#xE3;o <code>httr::POST</code>:</p>
<pre class="r"><code>url &lt;- &apos;http://www.ssp.sp.gov.br/Estatistica/Pesquisa.aspx&apos;
#c&#xF3;digo para dar um POST vazio no site
httr::POST(url)
#o resultado &#xE9; simplesmente o resultado original da p&#xE1;gina</code></pre>
<p>Para colocar par&#xE2;metros num POST, basta usar o par&#xE2;metro <code>body</code>. Antes de complicar, vamos tentar o conjunto de par&#xE2;metros mais simples de todos: vamos ignorar tudo que a gente n&#xE3;o sabe exatamente o que &#xE9; e preencher s&#xF3; o que sabemos:</p>
<pre class="r"><code>params &lt;- list(`__EVENTTARGET` = &quot;ctl00$conteudo$$ddlAnos&quot;, `__EVENTARGUMENT` = &quot;&quot;, `__LASTFOCUS` = &quot;&quot;, `__VIEWSTATE` = &quot;&quot;, `__EVENTVALIDATION` = &quot;&quot;, `ctl00$conteudo$ddlAnos` = &quot;2015&quot;, `ctl00$conteudo$ddlRegioes` = &quot;0&quot;, `ctl00$conteudo$ddlMunicipios` = &quot;0&quot;, `ctl00$conteudo$ddlDelegacias` = &quot;0&quot;)</code></pre>
<p>Agora vamos fazer a requisi&#xE7;&#xE3;o. O passo seguinte &#xE9; apenas pra traduzir o resultado pra um formato mais f&#xE1;cil de mexer.</p>
<pre class="r"><code>resposta &lt;- httr::POST(url, body = params, encode = &apos;form&apos;) %&gt;% xml2::read_html() # traduz o resultado</code></pre>
<p>Como vamos saber se deu certo? Existem v&#xE1;rios jeitos, mas, por simplicidade, aqui vamos apenas checar se alguma tabela contida em <code>resposta</code> &#xE9; igual &#xE0; tabela que extra&#xED;mos manualmente do site. Vamos fazer isso usando a fun&#xE7;&#xE3;o <code>rvest::html_table()</code>.</p>
<pre class="r"><code>resposta %&gt;% rvest::html_table()
# extrai todas as tabelas de um c&#xF3;digo em html.</code></pre>
<p>Como se v&#xEA; acima, nada que <em>se parece</em> com uma tabela na resposta da nossa requisi&#xE7;&#xE3;o &#xE9; a tabelinha que identificamos no site. Muita coisa pode ter dado errado, mas vamos come&#xE7;ar pelo que &#xE9; mais evidente: n&#xF3;s ignoramos os par&#xE2;metros <code>__VIEWSTATE</code> e <code>__EVENTVALIDATION</code>. Em &#xFA;ltima inst&#xE2;ncia, nos vamos precisar <em>entender</em> o que esses par&#xE2;metros significam, mas primeiro vamos tentar simplesmente obter uma c&#xF3;pia desses valores diretamente do site. Dando um ctrl+f no painel de ferramentas de desenvolvedor identificamos que o valores dessa vari&#xE1;veis sai de umas tags <code>input</code> nomeadas de acordo com o par&#xE2;metro que representam.</p>
<pre class="r"><code>view_state &lt;- httr::POST(url) %&gt;% xml2::read_html() %&gt;% rvest::html_nodes(&quot;input[name=&apos;__VIEWSTATE&apos;]&quot;) %&gt;% rvest::html_attr(&quot;value&quot;) event_validation &lt;- httr::POST(url) %&gt;% xml2::read_html() %&gt;% rvest::html_nodes(&quot;input[name=&apos;__EVENTVALIDATION&apos;]&quot;) %&gt;% rvest::html_attr(&quot;value&quot;)</code></pre>
<p>Com os nossos embustes em m&#xE3;os, basta pular para a pr&#xF3;xima etapa: tentar simular um clique no site. Nosso novo conjunto de par&#xE2;metros fica:</p>
<pre class="r"><code>params &lt;- list(`__EVENTTARGET` = &quot;ctl00$conteudo$$ddlAnos&quot;, `__EVENTARGUMENT` = &quot;&quot;, `__LASTFOCUS` = &quot;&quot;, `__VIEWSTATE` = view_state, `__EVENTVALIDATION` = event_validation, `ctl00$conteudo$ddlAnos` = &quot;2015&quot;, `ctl00$conteudo$ddlRegioes` = &quot;0&quot;, `ctl00$conteudo$ddlMunicipios` = &quot;0&quot;, `ctl00$conteudo$ddlDelegacias` = &quot;0&quot;)</code></pre>
<p>E o c&#xF3;digo da requisi&#xE7;&#xE3;o fica:</p>
<pre class="r"><code>resposta &lt;- httr::POST(url, body = params, encode = &apos;form&apos;) %&gt;% xml2::read_html() %&gt;% rvest::html_table()</code></pre>
<p>Exatamente a tabelinha que quer&#xED;amos! Entretanto, nem tudo s&#xE3;o flores. Como eu mencionei ali em cima, tanto a minha namorada quanto o NEV tinham interesse no n&#xFA;mero de BO&#x2019;s, que n&#xE3;o &#xE9; o que obtivemos fazendo a requisi&#xE7;&#xE3;o via R. Fu&#xE7;ando um pouco, &#xE9; f&#xE1;cil ver que o que obtivemos s&#xE3;o os n&#xFA;meros de produtividade policial. Ser&#xE1; que &#xE9; f&#xE1;cil mexer nos par&#xE2;metros pra obter os n&#xFA;meros de BO&#x2019;s?</p>
<p>Felizmente, a resposta &#xE9; sim, mas n&#xE3;o &#xE9; t&#xE3;o simples quanto parece. Se de outra tela qualquer voc&#xEA; clicar em &#x201C;Ocorr&#xEA;ncias Registradas por M&#xEA;s&#x201D; voc&#xEA; vai perceber que o &#x201C;__EVENTTARGET&quot; mudou para <code>ctl00$conteudo$$btnMes</code>, mas, a despeito do que se poderia imaginar, os outros par&#xE2;metros permaneceram com os nomes intactos.</p>
<p><img src="http://curso-r.com/blog/2017-05-19-scrapper-ssp_files/figure-html/unnamed-chunk-11-1.png" width="768"></p>
<p>Como essa requisi&#xE7;&#xE3;o sugere, voc&#xEA; consegue variar os tipos de informa&#xE7;&#xE3;o simplesmente variando o &#x201C;__EVENTTARGET&#x201C;. Com isso, uma requisi&#xE7;&#xE3;o para obter as&#x201D;Ocorr&#xEA;ncias Registradas por M&#xEA;s&quot; ficaria:</p>
<pre class="r"><code>params &lt;- list(`__EVENTTARGET` = &quot;ctl00$conteudo$$ddlAnos&quot;, `__EVENTARGUMENT` = &quot;&quot;, `__LASTFOCUS` = &quot;&quot;, `__VIEWSTATE` = view_state, `__EVENTVALIDATION` = event_validation, `ctl00$conteudo$ddlAnos` = &quot;2015&quot;, `ctl00$conteudo$ddlRegioes` = &quot;0&quot;, `ctl00$conteudo$ddlMunicipios` = &quot;0&quot;, `ctl00$conteudo$ddlDelegacias` = &quot;0&quot;) resposta &lt;- httr::POST(url, body = params, encode = &apos;form&apos;) %&gt;% xml2::read_html()</code></pre>
<p>&#xC9; importante notar que cada vez que vamos um POST desse, &#xE9; como se estivessemos entrando na p&#xE1;gina novamente, de tal forma que as informa&#xE7;&#xF5;es que a p&#xE1;gina tem quando damos v&#xE1;rios cliques seguidos s&#xE3;o diferentes das informa&#xE7;&#xF5;es de quando acessamos a p&#xE1;gina pelo R. Por exemplo, quando estamos navegando pela p&#xE1;gina pelos links, o &#x201C;__EVENTTARGET&quot; volta para <code>ctl00$conteudo$$ddlAnos</code> se voc&#xEA; trocar de p&#xE1;gina <em>saindo</em> de uma p&#xE1;gina de &#x201C;Ocorr&#xEA;ncias Registradas por M&#xEA;s&#x201D;, mas o tipo de informa&#xE7;&#xE3;o v&#xEA;m corretamente. Isso acontece porque, se voc&#xEA; acessar v&#xE1;rias p&#xE1;ginas em sequ&#xEA;ncia, a p&#xE1;gina sabe de onde voc&#xEA; veio.</p>
</div>
<div id="repita-quantas-vezes-quiser" class="section level2"> <p>Agora vem a repeti&#xE7;&#xE3;o, o passo final da raspagem. Antes de qualquer coisa precisamos de duas pequenas generaliza&#xE7;&#xF5;es: queremos baixar v&#xE1;rios anos e v&#xE1;rios munic&#xED;pios. Isso &#xE9; f&#xE1;cil de fazer pois os &#xED;ndices dos munic&#xED;pios s&#xE3;o as suas posi&#xE7;&#xF5;es em ordem alfab&#xE9;tica. Dessa forma, &#xE9; poss&#xED;vel fazer uma fun&#xE7;&#xE3;o que baixa as &#x201C;Ocorr&#xEA;ncias Registradas por M&#xEA;s&#x201D; de um munic&#xED;pio em um determinado ano:</p>
<pre class="r"><code>baixa_bo_municipio_ano &lt;- function(ano, municipio){
pivot &lt;- httr::GET(url)
#serve apenas para pegarmos um view_state e um event_validation valido view_state &lt;- pivot %&gt;% xml2::read_html() %&gt;% rvest::html_nodes(&quot;input[name=&apos;__VIEWSTATE&apos;]&quot;) %&gt;% rvest::html_attr(&quot;value&quot;) event_validation &lt;- pivot %&gt;% xml2::read_html() %&gt;% rvest::html_nodes(&quot;input[name=&apos;__EVENTVALIDATION&apos;]&quot;) %&gt;% rvest::html_attr(&quot;value&quot;) params &lt;- list(`__EVENTTARGET` = &quot;ctl00$conteudo$$btnMes&quot;, `__EVENTARGUMENT` = &quot;&quot;, `__LASTFOCUS` = &quot;&quot;, `__VIEWSTATE` = view_state, `__EVENTVALIDATION` = event_validation, `ctl00$conteudo$ddlAnos` = &quot;2015&quot;, `ctl00$conteudo$ddlRegioes` = &quot;0&quot;, `ctl00$conteudo$ddlMunicipios` = municipio, `ctl00$conteudo$ddlDelegacias` = &quot;0&quot;) httr::POST(url, body = params, encode = &apos;form&apos;) %&gt;% xml2::read_html() %&gt;% rvest::html_table() %&gt;% dplyr::first() %&gt;% #&apos; serve pra pegar apenas a primeira tabela da p&#xE1;gina, #&apos; se houver mais do que uma. Estou assumindo que a #&apos; tabela que eu quero &#xE9; sempre a primeira. dplyr::mutate(municipio = municipio, ano = ano) }</code></pre>
<p>Pra ilustar um grande loop, vamos baixar os BO&#x2019;s de todos os munic&#xED;pios, no ano de 2016. A fun&#xE7;&#xE3;o demora um pouco pra rodar, ent&#xE3;o quem quiser ver como fica o resultado final pode clicar <a href="https://github.com/curso-r/site/blob/master/content/blog/2017-05-19-scrapper-ssp/dados_ssp.rds">neste link</a>.</p>
<pre class="r"><code>GRID &lt;- expand.grid(municipio = 1:645, ano = &apos;2016&apos;, stringsAsFactors = F) D &lt;- purrr::by_row(GRID, baixa_bo_municipio_ano, .to = &quot;ocorrencias&quot;) %&gt;% tidyr::unnest(ocorrencias)</code></pre>
</div>
<div id="resultados" class="section level2"> <p>Com esses dados d&#xE1; pra fazer muitas coisas legais. &#xC9; poss&#xED;vel, por exemplo, fazer mapas como esse, que representa o n&#xFA;mero de homic&#xED;dios em 2016, por munic&#xED;pio. Ele foi feito em R, mas como faz&#xEA;-lo &#xE9; assunto pra outro post!</p>
<p><img src="http://curso-r.com/blog/2017-05-19-scrapper-ssp_files/figure-html/unnamed-chunk-15-1.png" width="672"></p>
</div> </div>
